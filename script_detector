-- Deleted not needed stuff
-- Preparation for HVH WAR
local_player = game.local_player

waypoints = menu:add_category("Script Detector")
--cheater_limit = menu:add_slider("Cheater Clicks per Second Limit", waypoints, 5, 50, 10, "The number of clicks per second to be labeled by the code as a scripter")
cheater_limit = 10 -- this param should be deleted
--time_limit_slider = menu:add_slider("Average Time Length", waypoints, 1, 20, 5, "Time interval to collect waypoints. Works best at 5 seconds, do not recommend changing.")
time_limit_slider = 5
waypoint_draw = menu:add_checkbox("Draw Clicks per Second Below Champions", waypoints, 1)

cheater_list = {}
for i, player in ipairs(game.players) do
    cheater_list[player.object_id] = false
end

tracker = {}
for i, player in ipairs(game.players) do
    tracker[player.object_id] = {
        path = {},
        time = {}
    }
end

local function IsValid(unit)

averages = {}
local function on_new_path(obj, path)
    if obj.is_valid then
        for i, player in ipairs(game.players) do
            if player.object_id == obj.object_id then
                table.insert(tracker[obj.object_id].path, path)
                table.insert(tracker[obj.object_id].time, game.game_time)
            end
        end
    end
end

local function on_draw()
	for i, player in pairs(tracker) do
		for j, time in pairs(player) do
			for k, actual_time in pairs(time) do
				if type(actual_time) == "number" then
					if actual_time <= game.game_time - menu:get_value(time_limit_slider) then
						table.remove(tracker[i].path, k)
						table.remove(tracker[i].time, k)
					end
				end
			end
		end
	end
	for i, player in pairs(tracker) do
		averages[i] = #player.time / menu:get_value(time_limit_slider)
		if averages[i] > tonumber(menu:get_value(cheater_limit)) and not cheater_list[i] and i ~= local_player.object_id then
			cheater_list[i] = true
			champ_name = game:get_object(i).champ_name
			game:print_chat("<font color='#9a7aa0'>" .. tostring(champ_name) .. " is scripting!</font>")
		end
	end
	if menu:get_value(waypoint_draw) == 1 then
		for i, player in ipairs(game.players) do
			if player.is_visible and player.is_alive then
				if averages[player.object_id] then
					if player.object_id == local_player.object_id then
						x, y = game:world_to_screen_2(player.origin.x, player.origin.y, player.origin.z).x, game:world_to_screen_2(player.origin.x, player.origin.y, player.origin.z - 25).y
					else
						x, y = game:world_to_screen_2(player.origin.x, player.origin.y, player.origin.z).x, game:world_to_screen_2(player.origin.x, player.origin.y, player.origin.z).y
					end
				renderer:draw_text_centered(x, y, tostring(averages[player.object_id]), 255, 255, 255, 255)
				end
			end
		end
	end
end

client:set_event_callback("on_new_path", on_new_path)
client:set_event_callback("on_draw", on_draw)
